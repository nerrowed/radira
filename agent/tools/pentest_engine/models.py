"""Data models for vulnerability scanning."""

from enum import Enum
from typing import List, Optional, Dict, Any
from dataclasses import dataclass, field
from datetime import datetime


class Severity(Enum):
    """Vulnerability severity levels."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class VulnerabilityType(Enum):
    """Types of vulnerabilities."""
    SQL_INJECTION = "sql_injection"
    XSS_REFLECTED = "xss_reflected"
    XSS_STORED = "xss_stored"
    XSS_DOM = "xss_dom"
    SSRF = "ssrf"
    XXE = "xxe"
    CSRF = "csrf"
    OPEN_REDIRECT = "open_redirect"
    LFI = "lfi"
    RFI = "rfi"
    COMMAND_INJECTION = "command_injection"
    PATH_TRAVERSAL = "path_traversal"
    IDOR = "idor"
    SECURITY_MISCONFIGURATION = "security_misconfiguration"
    SENSITIVE_DATA_EXPOSURE = "sensitive_data_exposure"
    BROKEN_AUTHENTICATION = "broken_authentication"
    BROKEN_ACCESS_CONTROL = "broken_access_control"
    API_SECURITY = "api_security"
    GRAPHQL_INTROSPECTION = "graphql_introspection"
    WEBSOCKET_SECURITY = "websocket_security"
    JWT_WEAKNESS = "jwt_weakness"
    CORS_MISCONFIGURATION = "cors_misconfiguration"
    CLICKJACKING = "clickjacking"
    INFORMATION_DISCLOSURE = "information_disclosure"


@dataclass
class Vulnerability:
    """Represents a discovered vulnerability."""

    type: VulnerabilityType
    severity: Severity
    url: str
    description: str
    evidence: str
    payload: Optional[str] = None
    parameter: Optional[str] = None
    request: Optional[str] = None
    response: Optional[str] = None
    remediation: Optional[str] = None
    cwe: Optional[str] = None
    cvss_score: Optional[float] = None
    timestamp: datetime = field(default_factory=datetime.now)

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary."""
        return {
            "type": self.type.value,
            "severity": self.severity.value,
            "url": self.url,
            "description": self.description,
            "evidence": self.evidence,
            "payload": self.payload,
            "parameter": self.parameter,
            "request": self.request,
            "response": self.response,
            "remediation": self.remediation,
            "cwe": self.cwe,
            "cvss_score": self.cvss_score,
            "timestamp": self.timestamp.isoformat()
        }


@dataclass
class ScanResult:
    """Results from a vulnerability scan."""

    target: str
    start_time: datetime
    end_time: Optional[datetime] = None
    vulnerabilities: List[Vulnerability] = field(default_factory=list)
    urls_scanned: int = 0
    urls_discovered: int = 0
    scan_duration: Optional[float] = None
    metadata: Dict[str, Any] = field(default_factory=dict)

    def add_vulnerability(self, vuln: Vulnerability):
        """Add a vulnerability to results."""
        self.vulnerabilities.append(vuln)

    def get_by_severity(self, severity: Severity) -> List[Vulnerability]:
        """Get vulnerabilities by severity."""
        return [v for v in self.vulnerabilities if v.severity == severity]

    def get_summary(self) -> Dict[str, int]:
        """Get vulnerability count summary."""
        summary = {
            "total": len(self.vulnerabilities),
            "critical": len(self.get_by_severity(Severity.CRITICAL)),
            "high": len(self.get_by_severity(Severity.HIGH)),
            "medium": len(self.get_by_severity(Severity.MEDIUM)),
            "low": len(self.get_by_severity(Severity.LOW)),
            "info": len(self.get_by_severity(Severity.INFO))
        }
        return summary

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary."""
        return {
            "target": self.target,
            "start_time": self.start_time.isoformat(),
            "end_time": self.end_time.isoformat() if self.end_time else None,
            "scan_duration": self.scan_duration,
            "urls_scanned": self.urls_scanned,
            "urls_discovered": self.urls_discovered,
            "summary": self.get_summary(),
            "vulnerabilities": [v.to_dict() for v in self.vulnerabilities],
            "metadata": self.metadata
        }


@dataclass
class ReconData:
    """Reconnaissance data collected."""

    target: str
    subdomains: List[str] = field(default_factory=list)
    dns_records: Dict[str, List[str]] = field(default_factory=dict)
    whois_info: Dict[str, Any] = field(default_factory=dict)
    tech_stack: List[str] = field(default_factory=list)
    endpoints: List[str] = field(default_factory=list)
    forms: List[Dict[str, Any]] = field(default_factory=list)
    cookies: Dict[str, str] = field(default_factory=dict)
    headers: Dict[str, str] = field(default_factory=dict)

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary."""
        return {
            "target": self.target,
            "subdomains": self.subdomains,
            "dns_records": self.dns_records,
            "whois_info": self.whois_info,
            "tech_stack": self.tech_stack,
            "endpoints": self.endpoints,
            "forms": self.forms,
            "cookies": self.cookies,
            "headers": self.headers
        }
