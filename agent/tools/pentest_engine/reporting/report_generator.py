"""Report generation for vulnerability scans."""

import json
import logging
from datetime import datetime
from pathlib import Path
from typing import Optional
from ..models import ScanResult, ReconData, Severity

logger = logging.getLogger(__name__)


class ReportGenerator:
    """Generate vulnerability scan reports in multiple formats."""

    def __init__(self, output_dir: str = "pentest_output"):
        """Initialize report generator.

        Args:
            output_dir: Directory for report output
        """
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(parents=True, exist_ok=True)

    def generate_json_report(
        self,
        scan_result: ScanResult,
        recon_data: Optional[ReconData] = None,
        filename: Optional[str] = None
    ) -> str:
        """Generate JSON format report.

        Args:
            scan_result: Scan results
            recon_data: Reconnaissance data (optional)
            filename: Output filename (auto-generated if None)

        Returns:
            Path to generated report
        """
        if not filename:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"scan_report_{timestamp}.json"

        output_path = self.output_dir / filename

        report_data = {
            "scan": scan_result.to_dict(),
        }

        if recon_data:
            report_data["reconnaissance"] = recon_data.to_dict()

        with open(output_path, 'w') as f:
            json.dump(report_data, f, indent=2)

        logger.info(f"JSON report generated: {output_path}")
        return str(output_path)

    def generate_text_report(
        self,
        scan_result: ScanResult,
        recon_data: Optional[ReconData] = None,
        filename: Optional[str] = None
    ) -> str:
        """Generate text format report.

        Args:
            scan_result: Scan results
            recon_data: Reconnaissance data (optional)
            filename: Output filename (auto-generated if None)

        Returns:
            Path to generated report
        """
        if not filename:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"scan_report_{timestamp}.txt"

        output_path = self.output_dir / filename

        with open(output_path, 'w') as f:
            # Header
            f.write("=" * 80 + "\n")
            f.write("RADIRA PENETRATION TEST REPORT\n")
            f.write("=" * 80 + "\n\n")

            # Scan Information
            f.write("SCAN INFORMATION\n")
            f.write("-" * 80 + "\n")
            f.write(f"Target: {scan_result.target}\n")
            f.write(f"Start Time: {scan_result.start_time.strftime('%Y-%m-%d %H:%M:%S')}\n")
            if scan_result.end_time:
                f.write(f"End Time: {scan_result.end_time.strftime('%Y-%m-%d %H:%M:%S')}\n")
            if scan_result.scan_duration:
                f.write(f"Duration: {scan_result.scan_duration:.2f} seconds\n")
            f.write(f"URLs Scanned: {scan_result.urls_scanned}\n")
            f.write(f"URLs Discovered: {scan_result.urls_discovered}\n\n")

            # Summary
            summary = scan_result.get_summary()
            f.write("VULNERABILITY SUMMARY\n")
            f.write("-" * 80 + "\n")
            f.write(f"Total Vulnerabilities: {summary['total']}\n")
            f.write(f"  Critical: {summary['critical']}\n")
            f.write(f"  High: {summary['high']}\n")
            f.write(f"  Medium: {summary['medium']}\n")
            f.write(f"  Low: {summary['low']}\n")
            f.write(f"  Info: {summary['info']}\n\n")

            # Reconnaissance Data
            if recon_data:
                f.write("RECONNAISSANCE DATA\n")
                f.write("-" * 80 + "\n")

                if recon_data.dns_records:
                    f.write("DNS Records:\n")
                    for record_type, records in recon_data.dns_records.items():
                        f.write(f"  {record_type}: {', '.join(records)}\n")
                    f.write("\n")

                if recon_data.tech_stack:
                    f.write(f"Technologies Detected: {', '.join(recon_data.tech_stack)}\n\n")

                if recon_data.endpoints:
                    f.write("Discovered Endpoints:\n")
                    for endpoint in recon_data.endpoints:
                        f.write(f"  {endpoint}\n")
                    f.write("\n")

                if recon_data.headers:
                    f.write("Security Headers:\n")
                    for header, value in recon_data.headers.items():
                        f.write(f"  {header}: {value}\n")
                    f.write("\n")

            # Vulnerabilities by Severity
            for severity in [Severity.CRITICAL, Severity.HIGH, Severity.MEDIUM, Severity.LOW, Severity.INFO]:
                vulns = scan_result.get_by_severity(severity)
                if not vulns:
                    continue

                f.write(f"\n{severity.value.upper()} SEVERITY VULNERABILITIES\n")
                f.write("=" * 80 + "\n\n")

                for i, vuln in enumerate(vulns, 1):
                    f.write(f"[{i}] {vuln.type.value.upper()}\n")
                    f.write("-" * 80 + "\n")
                    f.write(f"URL: {vuln.url}\n")
                    if vuln.parameter:
                        f.write(f"Parameter: {vuln.parameter}\n")
                    f.write(f"Description: {vuln.description}\n")
                    if vuln.payload:
                        f.write(f"Payload: {vuln.payload}\n")
                    if vuln.evidence:
                        f.write(f"Evidence: {vuln.evidence}\n")
                    if vuln.cwe:
                        f.write(f"CWE: {vuln.cwe}\n")
                    if vuln.cvss_score:
                        f.write(f"CVSS Score: {vuln.cvss_score}\n")
                    if vuln.remediation:
                        f.write(f"\nRemediation:\n{vuln.remediation}\n")
                    f.write("\n")

            # Footer
            f.write("=" * 80 + "\n")
            f.write("End of Report\n")
            f.write(f"Generated by RADIRA Pentest Engine v1.0 on {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write("=" * 80 + "\n")

        logger.info(f"Text report generated: {output_path}")
        return str(output_path)

    def generate_html_report(
        self,
        scan_result: ScanResult,
        recon_data: Optional[ReconData] = None,
        filename: Optional[str] = None
    ) -> str:
        """Generate HTML format report.

        Args:
            scan_result: Scan results
            recon_data: Reconnaissance data (optional)
            filename: Output filename (auto-generated if None)

        Returns:
            Path to generated report
        """
        if not filename:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"scan_report_{timestamp}.html"

        output_path = self.output_dir / filename

        summary = scan_result.get_summary()

        html = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RADIRA Pentest Report - {scan_result.target}</title>
    <style>
        body {{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }}
        .header {{
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }}
        .header h1 {{
            margin: 0 0 10px 0;
        }}
        .section {{
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }}
        .section h2 {{
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-top: 0;
        }}
        .summary {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }}
        .summary-item {{
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }}
        .critical {{ background-color: #fee; border-left: 4px solid #d32f2f; }}
        .high {{ background-color: #ffe; border-left: 4px solid #ff6f00; }}
        .medium {{ background-color: #fff3e0; border-left: 4px solid #ffa726; }}
        .low {{ background-color: #e8f5e9; border-left: 4px solid #66bb6a; }}
        .info {{ background-color: #e3f2fd; border-left: 4px solid #42a5f5; }}
        .vulnerability {{
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            background-color: #f9f9f9;
        }}
        .vulnerability h3 {{
            margin-top: 0;
            color: #333;
        }}
        .code {{
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }}
        .badge {{
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            margin-right: 10px;
        }}
        .badge-critical {{ background-color: #d32f2f; color: white; }}
        .badge-high {{ background-color: #ff6f00; color: white; }}
        .badge-medium {{ background-color: #ffa726; color: white; }}
        .badge-low {{ background-color: #66bb6a; color: white; }}
        .badge-info {{ background-color: #42a5f5; color: white; }}
        table {{
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }}
        th, td {{
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }}
        th {{
            background-color: #667eea;
            color: white;
        }}
        tr:hover {{
            background-color: #f5f5f5;
        }}
    </style>
</head>
<body>
    <div class="header">
        <h1>üîí RADIRA Penetration Test Report</h1>
        <p>Target: {scan_result.target}</p>
        <p>Scan Date: {scan_result.start_time.strftime('%Y-%m-%d %H:%M:%S')}</p>
    </div>

    <div class="section">
        <h2>üìä Executive Summary</h2>
        <div class="summary">
            <div class="summary-item critical">
                <h3>{summary['critical']}</h3>
                <p>Critical</p>
            </div>
            <div class="summary-item high">
                <h3>{summary['high']}</h3>
                <p>High</p>
            </div>
            <div class="summary-item medium">
                <h3>{summary['medium']}</h3>
                <p>Medium</p>
            </div>
            <div class="summary-item low">
                <h3>{summary['low']}</h3>
                <p>Low</p>
            </div>
            <div class="summary-item info">
                <h3>{summary['info']}</h3>
                <p>Info</p>
            </div>
        </div>
        <p><strong>Total Vulnerabilities:</strong> {summary['total']}</p>
        <p><strong>URLs Scanned:</strong> {scan_result.urls_scanned}</p>
        <p><strong>Scan Duration:</strong> {scan_result.scan_duration:.2f} seconds</p>
    </div>
"""

        # Reconnaissance section
        if recon_data:
            html += """
    <div class="section">
        <h2>üîç Reconnaissance Data</h2>
"""
            if recon_data.tech_stack:
                html += f"<p><strong>Technologies:</strong> {', '.join(recon_data.tech_stack)}</p>"

            if recon_data.endpoints:
                html += "<h3>Discovered Endpoints</h3><ul>"
                for endpoint in recon_data.endpoints[:20]:
                    html += f"<li>{endpoint}</li>"
                html += "</ul>"

            html += "</div>"

        # Vulnerabilities section
        html += """
    <div class="section">
        <h2>üêõ Detailed Findings</h2>
"""

        for severity in [Severity.CRITICAL, Severity.HIGH, Severity.MEDIUM, Severity.LOW, Severity.INFO]:
            vulns = scan_result.get_by_severity(severity)
            if not vulns:
                continue

            for vuln in vulns:
                severity_class = severity.value
                badge_class = f"badge-{severity.value}"

                html += f"""
        <div class="vulnerability {severity_class}">
            <h3>
                <span class="badge {badge_class}">{severity.value.upper()}</span>
                {vuln.type.value.replace('_', ' ').title()}
            </h3>
            <p><strong>URL:</strong> <code>{vuln.url}</code></p>
"""
                if vuln.parameter:
                    html += f"<p><strong>Parameter:</strong> <code>{vuln.parameter}</code></p>"

                html += f"<p><strong>Description:</strong> {vuln.description}</p>"

                if vuln.payload:
                    html += f'<p><strong>Payload:</strong></p><div class="code">{vuln.payload}</div>'

                if vuln.evidence:
                    html += f"<p><strong>Evidence:</strong> {vuln.evidence}</p>"

                if vuln.remediation:
                    html += f"<p><strong>Remediation:</strong> {vuln.remediation}</p>"

                if vuln.cwe:
                    html += f'<p><strong>CWE:</strong> <a href="https://cwe.mitre.org/data/definitions/{vuln.cwe.split("-")[1]}.html" target="_blank">{vuln.cwe}</a></p>'

                if vuln.cvss_score:
                    html += f"<p><strong>CVSS Score:</strong> {vuln.cvss_score}</p>"

                html += """
        </div>
"""

        html += """
    </div>

    <div class="section">
        <p style="text-align: center; color: #666;">
            <small>Generated by RADIRA Pentest Engine v1.0 on """ + datetime.now().strftime('%Y-%m-%d %H:%M:%S') + """</small>
        </p>
    </div>
</body>
</html>
"""

        with open(output_path, 'w') as f:
            f.write(html)

        logger.info(f"HTML report generated: {output_path}")
        return str(output_path)

    def generate_all_formats(
        self,
        scan_result: ScanResult,
        recon_data: Optional[ReconData] = None,
        base_filename: Optional[str] = None
    ) -> dict[str, str]:
        """Generate reports in all formats.

        Args:
            scan_result: Scan results
            recon_data: Reconnaissance data
            base_filename: Base filename (without extension)

        Returns:
            Dictionary mapping format to file path
        """
        if not base_filename:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            base_filename = f"scan_report_{timestamp}"

        reports = {
            'json': self.generate_json_report(scan_result, recon_data, f"{base_filename}.json"),
            'txt': self.generate_text_report(scan_result, recon_data, f"{base_filename}.txt"),
            'html': self.generate_html_report(scan_result, recon_data, f"{base_filename}.html"),
        }

        logger.info(f"Generated reports in all formats: {list(reports.keys())}")
        return reports
